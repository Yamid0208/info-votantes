import{Ab as y,Bb as w,Jb as s,La as p,Za as E,bb as x,c as l,da as u,ea as v,jb as g,jc as S,kb as o,lb as a,mb as m,oc as D,sb as b,ub as C,vb as f,zb as _}from"./chunk-PA5UXIOC.js";var R=["video"],z=["canvas"];function F(r,n){if(r&1){let e=b();o(0,"div",7)(1,"div",8),m(2,"div",9)(3,"div",10)(4,"div",11)(5,"div",12),a(),o(6,"div",13),m(7,"div",14),o(8,"p"),s(9,"Posiciona tu c\xE9dula dentro del marco"),a()(),o(10,"button",15),C("click",function(){u(e);let i=f();return v(i.stopScanning())}),o(11,"span"),s(12,"\u2715"),a(),s(13," Cancelar "),a()()}}function V(r,n){r&1&&(o(0,"div",20)(1,"div",21)(2,"span",22),s(3,"\u2713"),a(),o(4,"h3"),s(5,"C\xE9dula Detectada"),a(),o(6,"p"),s(7,"Tu documento ha sido capturado exitosamente"),a()()())}function U(r,n){if(r&1){let e=b();o(0,"div",16)(1,"h2"),s(2,"Esc\xE1ner de C\xE9dula"),a(),o(3,"p"),s(4,"Presiona el bot\xF3n para comenzar a escanear tu c\xE9dula de ciudadan\xEDa colombiana"),a(),o(5,"button",17),C("click",function(){u(e);let i=f();return v(i.startScanning())}),o(6,"span",18),s(7,"\u{1F4F7}"),a(),s(8," Iniciar Escaneo "),a(),x(9,V,8,0,"div",19),a()}if(r&2){let e=f();p(9),g("ngIf",e.documentDetected)}}var k=class r{video;canvas;stream;cap;animationId;isScanning=!1;documentDetected=!1;detectionConfidence=0;consecutiveDetections=0;requiredDetections=3;hasLoggedBindingError=!1;src;gray;edges;hsv;mask;ngAfterViewInit(){}startScanning(){this.isScanning||(this.isScanning=!0,this.documentDetected=!1,this.consecutiveDetections=0,this.hasLoggedBindingError=!1,this.waitForOpenCV())}stopScanning(){this.isScanning=!1,this.documentDetected=!1,this.consecutiveDetections=0,this.stopCamera()}waitForOpenCV(){cv?.Mat?this.initCamera():setTimeout(()=>this.waitForOpenCV(),100)}initCamera(){return l(this,null,function*(){if(!this.isScanning)return;this.stream=yield navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});let n=this.video.nativeElement;n.srcObject=this.stream,n.play(),n.onloadedmetadata=()=>{if(!this.isScanning){this.stopCamera();return}let e=n.videoWidth,t=n.videoHeight;if(!e||!t){console.error("Video size inv\xE1lido");return}n.width=e,n.height=t;let i=this.canvas.nativeElement;i.width=e,i.height=t,this.cap=new cv.VideoCapture(n),this.src?.delete(),this.gray?.delete(),this.edges?.delete(),this.hsv?.delete(),this.mask?.delete(),this.src=new cv.Mat(t,e,cv.CV_8UC4),this.gray=new cv.Mat(t,e,cv.CV_8UC1),this.edges=new cv.Mat(t,e,cv.CV_8UC1),this.hsv=new cv.Mat(t,e,cv.CV_8UC3),this.mask=new cv.Mat(t,e,cv.CV_8UC1),this.processFrame()}})}detectColombianIdCard(n,e){if(n.size()===0)return!1;let t=0,i=3e4,I=5e5,A=1.3,T=2;for(let h=0;h<n.size();h++){let d=n.get(h),M=cv.contourArea(d);if(M<i||M>I)continue;let c=cv.boundingRect(d),O=c.width/c.height;if(O>=A&&O<=T){let N=cv.arcLength(d,!0),P=cv.approxPolyDP(d,.02*N,!0);P.rows===4&&(t++,cv.rectangle(this.src,new cv.Point(c.x,c.y),new cv.Point(c.x+c.width,c.y+c.height),new cv.Scalar(0,255,0,255),3)),P.delete()}}return this.detectionConfidence=t,t>0}captureAndProcessDocument(){return l(this,null,function*(){if(!this.isScanning)return;let n=this.canvas.nativeElement,e=n.toDataURL("image/jpeg",.95);console.log("\u2713 C\xE9dula Colombiana detectada y capturada"),console.log("\u2500".repeat(50)),console.log("\u{1F4CB} INFORMACI\xD3N DE CAPTURA"),console.log("\u2500".repeat(50)),console.log("Timestamp:",new Date().toLocaleString("es-CO")),console.log("Resoluci\xF3n:",`${n.width}x${n.height}`),console.log("Tama\xF1o aprox:",`${(e.length/1024).toFixed(2)} KB`),console.log("Detecciones en frame:",`${this.detectionConfidence}`),console.log("\u2500".repeat(50)),this.documentDetected=!0,this.isScanning=!1,this.stopCamera(),yield this.sendImageToServer(e)})}sendImageToServer(n){return l(this,null,function*(){try{let e=yield fetch("/api/process-document",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:n,documentType:"colombian_id"})});if(e.ok){let t=yield e.json();console.log("\u2705 DATOS EXTRA\xCDDOS DE LA C\xC9DULA"),console.log("\u2500".repeat(50)),console.log("N\xFAmero de documento:",t.documentNumber||"No detectado"),console.log("Nombre completo:",t.fullName||"No detectado"),console.log("Apellido:",t.lastName||"No detectado"),console.log("Nombre:",t.firstName||"No detectado"),console.log("Fecha de nacimiento:",t.dateOfBirth||"No detectado"),console.log("Lugar de expedici\xF3n:",t.placeOfIssue||"No detectado"),console.log("Fecha de expedici\xF3n:",t.dateOfIssue||"No detectado"),console.log("Fecha de vencimiento:",t.expirationDate||"No detectado"),console.log("Sexo:",t.gender||"No detectado"),console.log("Tipo de sangre:",t.bloodType||"No detectado"),console.log("\u2500".repeat(50)),console.log("\u{1F4CA} Respuesta completa del servidor:",t),this.isScanning=!1}else console.warn("\u26A0\uFE0F El servidor respondi\xF3 con estado:",e.status),console.log("Imagen capturada (Base64):",n.substring(0,100)+"..."),this.isScanning=!1}catch(e){console.error("\u274C Error en sendImageToServer:",e),console.log("Imagen capturada (Base64):",n.substring(0,100)+"...")}})}processFrame(){if(!this.isScanning||!this.cap||!this.src||!this.gray||!this.edges||!this.stream?.active||this.video.nativeElement.readyState<2){this.isScanning&&(this.animationId=requestAnimationFrame(()=>this.processFrame()));return}try{this.cap.read(this.src),cv.cvtColor(this.src,this.gray,cv.COLOR_RGBA2GRAY),cv.GaussianBlur(this.gray,this.gray,new cv.Size(5,5),0),cv.Canny(this.gray,this.edges,75,200);let n=cv.getStructuringElement(cv.MORPH_RECT,new cv.Size(3,3));cv.dilate(this.edges,this.edges,n,new cv.Point(-1,-1),2);let e=new cv.MatVector,t=new cv.Mat;cv.findContours(this.edges,e,t,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE),this.detectColombianIdCard(e,t)?this.consecutiveDetections++:this.consecutiveDetections=0,this.consecutiveDetections>=this.requiredDetections&&!this.documentDetected&&this.captureAndProcessDocument(),cv.imshow(this.canvas.nativeElement,this.src),n.delete(),e.delete(),t.delete(),this.animationId=requestAnimationFrame(()=>this.processFrame())}catch(n){if(n?.name==="BindingError"){this.hasLoggedBindingError||(console.error("Error en processFrame BindingError",n),this.hasLoggedBindingError=!0),this.stopScanning();return}console.error("Error en processFrame",n),this.animationId=requestAnimationFrame(()=>this.processFrame())}}stopCamera(){this.animationId&&cancelAnimationFrame(this.animationId),this.stream?.getTracks().forEach(n=>n.stop()),this.stream=void 0,this.cap=void 0}ngOnDestroy(){this.stopCamera(),this.src?.delete(),this.gray?.delete(),this.edges?.delete(),this.hsv?.delete(),this.mask?.delete()}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=E({type:r,selectors:[["app-users"]],viewQuery:function(e,t){if(e&1&&(_(R,5),_(z,5)),e&2){let i;y(i=w())&&(t.video=i.first),y(i=w())&&(t.canvas=i.first)}},decls:8,vars:2,consts:[["video",""],["canvas",""],[1,"scanner-container"],[1,"scanner-wrapper"],["hidden",""],["class","scanner-overlay",4,"ngIf"],["class","control-panel",4,"ngIf"],[1,"scanner-overlay"],[1,"scan-frame"],[1,"frame-corner","corner-top-left"],[1,"frame-corner","corner-top-right"],[1,"frame-corner","corner-bottom-left"],[1,"frame-corner","corner-bottom-right"],[1,"scan-indicator"],[1,"scan-line"],[1,"btn-stop",3,"click"],[1,"control-panel"],[1,"btn-scan",3,"click"],[1,"icon"],["class","info-panel",4,"ngIf"],[1,"info-panel"],[1,"success-message"],[1,"checkmark"]],template:function(e,t){e&1&&(o(0,"div",2)(1,"div",3),m(2,"video",4,0)(4,"canvas",null,1),x(6,F,14,0,"div",5)(7,U,10,1,"div",6),a()()),e&2&&(p(6),g("ngIf",t.isScanning),p(),g("ngIf",!t.isScanning))},dependencies:[D,S],styles:[".scanner-container[_ngcontent-%COMP%]{position:relative;width:100%;height:100vh;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}.scanner-wrapper[_ngcontent-%COMP%]{position:relative;width:100%;height:100%}video[_ngcontent-%COMP%], canvas[_ngcontent-%COMP%]{position:absolute;width:100%;height:100%;object-fit:cover}.scanner-overlay[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;background:#00000080;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10}.scan-frame[_ngcontent-%COMP%]{position:relative;width:320px;height:200px;border:3px solid rgba(0,255,100,.7);border-radius:8px;background:#00ff640d;box-shadow:0 0 20px #00ff644d,inset 0 0 20px #00ff641a;margin-bottom:40px;animation:_ngcontent-%COMP%_pulse-border 2s ease-in-out infinite}.frame-corner[_ngcontent-%COMP%]{position:absolute;width:30px;height:30px;border:3px solid #00ff64}.corner-top-left[_ngcontent-%COMP%]{top:-5px;left:-5px;border-right:none;border-bottom:none;border-radius:8px 0 0}.corner-top-right[_ngcontent-%COMP%]{top:-5px;right:-5px;border-left:none;border-bottom:none;border-radius:0 8px 0 0}.corner-bottom-left[_ngcontent-%COMP%]{bottom:-5px;left:-5px;border-right:none;border-top:none;border-radius:0 0 0 8px}.corner-bottom-right[_ngcontent-%COMP%]{bottom:-5px;right:-5px;border-left:none;border-top:none;border-radius:0 0 8px}@keyframes _ngcontent-%COMP%_pulse-border{0%,to{box-shadow:0 0 20px #00ff644d,inset 0 0 20px #00ff641a}50%{box-shadow:0 0 40px #00ff6499,inset 0 0 30px #00ff6433}}.scan-indicator[_ngcontent-%COMP%]{text-align:center;color:#fff;margin-bottom:30px}.scan-indicator[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:16px;margin:15px 0 0;color:#fffc}.scan-line[_ngcontent-%COMP%]{width:310px;height:3px;background:linear-gradient(90deg,transparent,#00ff64,transparent);margin:0 auto;animation:_ngcontent-%COMP%_scan-animation 1.5s ease-in-out infinite}@keyframes _ngcontent-%COMP%_scan-animation{0%{transform:translateY(-80px);opacity:0}50%{opacity:1}to{transform:translateY(80px);opacity:0}}.btn-stop[_ngcontent-%COMP%]{position:absolute;bottom:30px;right:30px;padding:12px 24px;background:#ff3c3ce6;color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .3s ease;z-index:20;box-shadow:0 4px 15px #ff3c3c66}.btn-stop[_ngcontent-%COMP%]:hover{background:#ff3c3c;box-shadow:0 6px 20px #ff3c3c99;transform:translateY(-2px)}.btn-stop[_ngcontent-%COMP%]:active{transform:translateY(0)}.btn-stop[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:20px;font-weight:700}.control-panel[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;color:#fff;z-index:15;background:linear-gradient(135deg,#000c,#141428cc)}.control-panel[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:32px;font-weight:700;margin-bottom:16px;background:linear-gradient(135deg,#00ff64,#00d4ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.control-panel[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:16px;color:#ffffffb3;max-width:400px;margin-bottom:40px;line-height:1.6}.btn-scan[_ngcontent-%COMP%]{padding:16px 48px;background:linear-gradient(135deg,#00ff64,#00d4ff);color:#000;border:none;border-radius:50px;font-size:18px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all .3s ease;box-shadow:0 8px 25px #00ff644d;margin-bottom:40px}.btn-scan[_ngcontent-%COMP%]:hover{transform:translateY(-4px);box-shadow:0 12px 35px #00ff6480}.btn-scan[_ngcontent-%COMP%]:active{transform:translateY(-2px)}.btn-scan[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{font-size:24px}.info-panel[_ngcontent-%COMP%]{margin-top:40px;padding:30px;background:#00ff641a;border:2px solid #00ff64;border-radius:12px;max-width:400px;animation:_ngcontent-%COMP%_slideUp .5s ease-out}@keyframes _ngcontent-%COMP%_slideUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.success-message[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:12px}.checkmark[_ngcontent-%COMP%]{font-size:48px;color:#00ff64;animation:_ngcontent-%COMP%_scaleIn .5s cubic-bezier(.68,-.55,.265,1.55)}@keyframes _ngcontent-%COMP%_scaleIn{0%{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}.success-message[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:24px;margin:0;color:#00ff64}.success-message[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:14px;color:#fff9;margin:0}@media (max-width: 768px){.scan-frame[_ngcontent-%COMP%]{width:280px;height:160px}.scan-line[_ngcontent-%COMP%]{width:270px}.control-panel[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:24px}.btn-scan[_ngcontent-%COMP%]{padding:14px 36px;font-size:16px}.btn-stop[_ngcontent-%COMP%]{bottom:20px;right:20px;padding:10px 18px;font-size:14px}.info-panel[_ngcontent-%COMP%]{max-width:90%}}"]})};export{k as Users};
